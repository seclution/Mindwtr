name: Release macOS App Store

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  macos-appstore:
    runs-on: macos-15
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0"

      - name: Validate required secrets
        env:
          MAS_CERTIFICATE: ${{ secrets.MAS_CERTIFICATE }}
          MAS_CERTIFICATE_BASE64: ${{ secrets.MAS_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          MAS_CERTIFICATE_PWD: ${{ secrets.MAS_CERTIFICATE_PWD }}
          MAS_CERTIFICATE_PASSWORD: ${{ secrets.MAS_CERTIFICATE_PASSWORD }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          MAS_PROVISIONING_PROFILE: ${{ secrets.MAS_PROVISIONING_PROFILE }}
          MAS_SIGNING_IDENTITY: ${{ secrets.MAS_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail
          CERT_B64="${MAS_CERTIFICATE:-${MAS_CERTIFICATE_BASE64:-${APPLE_CERTIFICATE:-}}}"
          CERT_PWD="${MAS_CERTIFICATE_PWD:-${MAS_CERTIFICATE_PASSWORD:-${APPLE_CERTIFICATE_PASSWORD:-}}}"
          missing=0
          for key in MAS_PROVISIONING_PROFILE MAS_SIGNING_IDENTITY; do
            if [ -z "${!key:-}" ]; then
              echo "::error::Missing required secret: $key"
              missing=1
            fi
          done
          if [ -z "${CERT_B64:-}" ]; then
            echo "::error::Missing signing certificate secret. Set MAS_CERTIFICATE (or MAS_CERTIFICATE_BASE64)."
            missing=1
          fi
          if [ -z "${CERT_PWD:-}" ]; then
            echo "::warning::No certificate password secret found (MAS_CERTIFICATE_PWD / MAS_CERTIFICATE_PASSWORD / APPLE_CERTIFICATE_PASSWORD)."
            echo "::warning::This is valid only if the exported .p12 has an empty password."
          fi
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Import Mac App Store certificate
        env:
          MAS_CERTIFICATE: ${{ secrets.MAS_CERTIFICATE }}
          MAS_CERTIFICATE_BASE64: ${{ secrets.MAS_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          MAS_CERTIFICATE_PWD: ${{ secrets.MAS_CERTIFICATE_PWD }}
          MAS_CERTIFICATE_PASSWORD: ${{ secrets.MAS_CERTIFICATE_PASSWORD }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail
          CERT_B64="${MAS_CERTIFICATE:-${MAS_CERTIFICATE_BASE64:-${APPLE_CERTIFICATE:-}}}"
          CERT_PWD="${MAS_CERTIFICATE_PWD:-${MAS_CERTIFICATE_PASSWORD:-${APPLE_CERTIFICATE_PASSWORD:-}}}"
          KEYCHAIN_PATH="$RUNNER_TEMP/mindwtr-mas.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24)"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"

          CERT_PATH="$RUNNER_TEMP/mas-signing.p12"
          if ! printf '%s' "$CERT_B64" | tr -d '\r' | base64 --decode > "$CERT_PATH" 2>/dev/null; then
            printf '%s' "$CERT_B64" | tr -d '\r' | base64 -D > "$CERT_PATH"
          fi

          if ! openssl pkcs12 -in "$CERT_PATH" -passin "pass:${CERT_PWD:-}" -nokeys -clcerts >/dev/null 2>&1; then
            echo "::error::Unable to open the decoded .p12 with the provided password."
            echo "::error::Re-export your Apple Distribution certificate as .p12 and update the matching password secret."
            exit 1
          fi

          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "${CERT_PWD:-}" -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/productbuild
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        env:
          MAS_PROVISIONING_PROFILE: ${{ secrets.MAS_PROVISIONING_PROFILE }}
        run: |
          set -euo pipefail
          PROFILE_PATH="$RUNNER_TEMP/mindwtr-mas.provisionprofile"
          if ! echo "$MAS_PROVISIONING_PROFILE" | base64 --decode > "$PROFILE_PATH" 2>/dev/null; then
            echo "$MAS_PROVISIONING_PROFILE" | base64 -D > "$PROFILE_PATH"
          fi

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/mindwtr-mas.provisionprofile"
          cp "$PROFILE_PATH" apps/desktop/src-tauri/embedded.provisionprofile

      - name: Build signed macOS app bundle (App Store)
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.MAS_SIGNING_IDENTITY }}
          CMAKE_C_FLAGS: -march=armv8.2-a+dotprod
          CMAKE_CXX_FLAGS: -march=armv8.2-a+dotprod
          TAURI_LOG_LEVEL: debug
        run: |
          set -euo pipefail
          cd apps/desktop
          cargo tauri build \
            --target aarch64-apple-darwin \
            --bundles app \
            --config src-tauri/tauri.appstore.conf.json

      - name: Build signed installer package
        env:
          MAS_SIGNING_IDENTITY: ${{ secrets.MAS_SIGNING_IDENTITY }}
          MAS_INSTALLER_SIGNING_IDENTITY: ${{ secrets.MAS_INSTALLER_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail
          APP_PATH="$(find apps/desktop/src-tauri/target/aarch64-apple-darwin/release/bundle/macos -maxdepth 1 -name '*.app' | head -n 1)"
          if [ -z "${APP_PATH:-}" ]; then
            echo "::error::Built .app bundle not found"
            exit 1
          fi

          INSTALLER_IDENTITY="${MAS_INSTALLER_SIGNING_IDENTITY:-$MAS_SIGNING_IDENTITY}"
          if [ -z "${INSTALLER_IDENTITY:-}" ]; then
            echo "::error::Missing installer identity. Set MAS_INSTALLER_SIGNING_IDENTITY (or MAS_SIGNING_IDENTITY)."
            exit 1
          fi

          APP_BUNDLE_DIR="$(dirname "$APP_PATH")"
          BUNDLE_DIR="$(dirname "$APP_BUNDLE_DIR")"
          PKG_DIR="$BUNDLE_DIR/pkg"
          PKG_PATH="$PKG_DIR/Mindwtr-mac-appstore.pkg"
          mkdir -p "$PKG_DIR"

          xcrun productbuild \
            --component "$APP_PATH" /Applications \
            --sign "$INSTALLER_IDENTITY" \
            "$PKG_PATH"

          echo "PKG_PATH=$PKG_PATH" >> "$GITHUB_ENV"
          ls -la "$PKG_DIR"

      - name: Upload to App Store Connect
        env:
          MAS_APPLE_ID: ${{ secrets.MAS_APPLE_ID }}
          MAS_APPLE_PASSWORD: ${{ secrets.MAS_APPLE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        run: |
          set -euo pipefail
          UPLOAD_APPLE_ID="${MAS_APPLE_ID:-${APPLE_ID:-}}"
          UPLOAD_APPLE_PASSWORD="${MAS_APPLE_PASSWORD:-${APPLE_PASSWORD:-}}"
          if [ -z "${UPLOAD_APPLE_ID:-}" ] || [ -z "${UPLOAD_APPLE_PASSWORD:-}" ]; then
            echo "::error::Missing upload credentials. Set APPLE_ID + APPLE_PASSWORD (or MAS_APPLE_ID / MAS_APPLE_PASSWORD)."
            exit 1
          fi
          if [ -z "${PKG_PATH:-}" ] || [ ! -f "$PKG_PATH" ]; then
            echo "::error::PKG file not found: ${PKG_PATH:-<empty>}"
            exit 1
          fi

          xcrun altool --upload-app --type macos --file "$PKG_PATH" --username "$UPLOAD_APPLE_ID" --password "$UPLOAD_APPLE_PASSWORD"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: mindwtr-macos-appstore-pkg
          path: ${{ env.PKG_PATH }}
          if-no-files-found: error

      - name: Cleanup signing files
        if: always()
        run: |
          rm -f apps/desktop/src-tauri/embedded.provisionprofile
          if [ -n "${KEYCHAIN_PATH:-}" ] && [ -f "${KEYCHAIN_PATH}" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
