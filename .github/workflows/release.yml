name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  linux:
    uses: ./.github/workflows/release-linux.yml
    secrets: inherit

  macos:
    uses: ./.github/workflows/release-macos.yml
    secrets: inherit

  windows:
    uses: ./.github/workflows/release-windows.yml
    secrets: inherit

  android:
    uses: ./.github/workflows/release-android.yml
    secrets: inherit

  release:
    needs: [linux, macos, windows, android]
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: ./release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -la ./release-assets/ || echo "No assets found"

      - name: Resolve release notes
        id: release_notes
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          NOTES_PATH="docs/release-notes/${CURRENT_TAG}.md"
          ALT_NOTES_PATH="docs/release-notes/${CURRENT_TAG#v}.md"
          if [ -f "$NOTES_PATH" ]; then
            echo "Using release notes at $NOTES_PATH"
            echo "body_path=$NOTES_PATH" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -f "$ALT_NOTES_PATH" ]; then
            echo "Using release notes at $ALT_NOTES_PATH"
            echo "body_path=$ALT_NOTES_PATH" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "No release notes file found; falling back to generated changelog."
          echo "body_path=CHANGELOG.md" >> "$GITHUB_OUTPUT"

      - name: Generate Changelog
        id: changelog
        if: ${{ steps.release_notes.outputs.body_path == 'CHANGELOG.md' }}
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "## What's Changed in $CURRENT_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            git log --pretty=format:"- %s" >> CHANGELOG.md
          fi
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG" >> CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./release-assets/*
          body_path: ${{ steps.release_notes.outputs.body_path }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-packages:
    needs: release
    runs-on: ubuntu-latest
    name: Update Homebrew/Scoop Packages
    if: startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success'
    steps:
      - name: Checkout packages repo
        uses: actions/checkout@v4
        with:
          repository: dongdongbh/homebrew-mindwtr
          token: ${{ secrets.PACKAGES_REPO_TOKEN }}
          path: packages-repo

      - name: Resolve release version
        id: version
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          TAG="${INPUT_TAG:-${GITHUB_REF#refs/tags/}}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download release assets and compute hashes
        id: hashes
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          URL_DMG_ARM="https://github.com/${{ github.repository }}/releases/download/${TAG}/mindwtr_${VERSION}_aarch64.dmg"
          URL_DMG_INTEL="https://github.com/${{ github.repository }}/releases/download/${TAG}/mindwtr_${VERSION}_x64.dmg"
          URL_EXE="https://github.com/${{ github.repository }}/releases/download/${TAG}/mindwtr_${VERSION}_x64-setup.exe"

          echo "Waiting for release assets to become available..."
          for attempt in $(seq 1 10); do
            if curl -fsI "$URL_DMG_ARM" >/dev/null && \
               curl -fsI "$URL_DMG_INTEL" >/dev/null && \
               curl -fsI "$URL_EXE" >/dev/null; then
              echo "Release assets are available."
              break
            fi
            if [ "$attempt" -eq 10 ]; then
              echo "Release assets not available after waiting."
              exit 1
            fi
            sleep 15
          done

          curl -fL -o mindwtr-arm.dmg "$URL_DMG_ARM"
          curl -fL -o mindwtr-intel.dmg "$URL_DMG_INTEL"
          curl -fL -o mindwtr.exe "$URL_EXE"

          SHA_ARM=$(sha256sum mindwtr-arm.dmg | awk '{print $1}')
          SHA_INTEL=$(sha256sum mindwtr-intel.dmg | awk '{print $1}')
          SHA_EXE=$(sha256sum mindwtr.exe | awk '{print $1}')

          echo "sha_arm=$SHA_ARM" >> "$GITHUB_OUTPUT"
          echo "sha_intel=$SHA_INTEL" >> "$GITHUB_OUTPUT"
          echo "sha_exe=$SHA_EXE" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew cask
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA_ARM="${{ steps.hashes.outputs.sha_arm }}"
          SHA_INTEL="${{ steps.hashes.outputs.sha_intel }}"

          FILE="packages-repo/Casks/mindwtr.rb"
          ruby -pi -e "sub(/^  version \".*\"/, \"  version \\\"$VERSION\\\"\")" "$FILE"
          ruby -0777 -pi -e "sub(/sha256 arm:.*?intel: \\\"[^\\\"]+\\\"/m, \"sha256 arm:   \\\"$SHA_ARM\\\",\\n         intel: \\\"$SHA_INTEL\\\"\")" "$FILE"

      - name: Update Scoop manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA_EXE="${{ steps.hashes.outputs.sha_exe }}"
          URL_EXE="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/mindwtr_${VERSION}_x64-setup.exe#/dl.7z"

          FILE="packages-repo/bucket/mindwtr.json"
          jq --arg v "$VERSION" \
             --arg url "$URL_EXE" \
             --arg hash "$SHA_EXE" \
             '.version = $v
              | .architecture."64bit".url = $url
              | .architecture."64bit".hash = $hash
             | .autoupdate.architecture."64bit".url = "https://github.com/dongdongbh/Mindwtr/releases/download/v\($v)/mindwtr_\($v)_x64-setup.exe#/dl.7z"' \
             "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"

      - name: Check Winget package exists
        id: winget_check
        run: |
          PKG_ID="dongdongbh.Mindwtr"
          PKG_LOWER="${PKG_ID,,}"
          FIRST="${PKG_LOWER:0:1}"
          URL="https://github.com/microsoft/winget-pkgs/tree/master/manifests/${FIRST}/${PKG_ID//./\/}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
          if [ "$STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Winget package not found yet; skipping submission."
          fi

      - name: Checkout winget-pkgs fork
        if: steps.winget_check.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          repository: dongdongbh/winget-pkgs
          token: ${{ secrets.PACKAGES_REPO_TOKEN }}
          path: winget-pkgs

      - name: Prepare Winget manifests
        if: steps.winget_check.outputs.exists == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          REPO="${{ github.repository }}"
          SHA_EXE="${{ steps.hashes.outputs.sha_exe }}"
          RELEASE_DATE="$(date -u +%Y-%m-%d)"
          INSTALLER_URL="https://github.com/${REPO}/releases/download/${TAG}/mindwtr_${VERSION}_x64-setup.exe"
          MANIFEST_DIR="winget-pkgs/manifests/d/dongdongbh/Mindwtr/${VERSION}"

          mkdir -p "$MANIFEST_DIR"

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.installer.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.installer.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          InstallerLocale: en-US
          InstallerType: nullsoft
          InstallModes:
            - interactive
            - silent
          UpgradeBehavior: install
          Commands:
            - mindwtr
          Dependencies:
            PackageDependencies:
              - PackageIdentifier: Microsoft.VCRedist.2015+.x64
          ProductCode: Mindwtr
          ReleaseDate: ${RELEASE_DATE}
          AppsAndFeaturesEntries:
            - ProductCode: Mindwtr
          InstallationMetadata:
            DefaultInstallLocation: '%LOCALAPPDATA%\\Programs\\Mindwtr'
          Installers:
            - Architecture: x64
              InstallerUrl: ${INSTALLER_URL}
              InstallerSha256: ${SHA_EXE}
          ManifestType: installer
          ManifestVersion: 1.10.0
          EOF

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.locale.en-US.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.defaultLocale.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          PackageLocale: en-US
          Publisher: dongdongbh
          PublisherUrl: https://github.com/dongdongbh
          PublisherSupportUrl: https://github.com/dongdongbh/Mindwtr/issues
          Author: dongdongbh
          PackageName: Mindwtr
          PackageUrl: https://github.com/dongdongbh/Mindwtr
          License: AGPL-3.0
          LicenseUrl: https://github.com/dongdongbh/Mindwtr/blob/HEAD/LICENSE
          ShortDescription: A complete Getting Things Done (GTD) productivity system.
          Description: A complete Getting Things Done (GTD) productivity system.
          Moniker: mindwtr
          Tags:
            - cross-platform
            - getting-things-done
            - gtd
            - gtd-applications
            - gtd-workflow
            - personal-management
            - productivity
            - second-brain
            - task-management
            - todo-app
          ReleaseNotesUrl: https://github.com/${REPO}/releases/tag/${TAG}
          ManifestType: defaultLocale
          ManifestVersion: 1.10.0
          EOF

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.locale.zh-CN.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.locale.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          PackageLocale: zh-CN
          Publisher: dongdongbh
          PublisherUrl: https://github.com/dongdongbh
          PublisherSupportUrl: https://github.com/dongdongbh/Mindwtr/issues
          Author: dongdongbh
          PackageName: Mindwtr
          PackageUrl: https://github.com/dongdongbh/Mindwtr
          License: AGPL-3.0
          LicenseUrl: https://github.com/dongdongbh/Mindwtr/blob/HEAD/LICENSE
          ShortDescription: 完整的 GTD（搞定）任务管理系统。
          Description: 完整的 GTD（搞定）任务管理系统。
          Moniker: mindwtr
          Tags:
            - cross-platform
            - getting-things-done
            - gtd
            - gtd-applications
            - gtd-workflow
            - personal-management
            - productivity
            - second-brain
            - task-management
            - todo-app
          ReleaseNotesUrl: https://github.com/${REPO}/releases/tag/${TAG}
          ManifestType: locale
          ManifestVersion: 1.10.0
          EOF

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.version.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.10.0
          EOF

      - name: Submit Winget PR
        if: steps.winget_check.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.PACKAGES_REPO_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="mindwtr-${VERSION}"
          cd winget-pkgs
          git checkout -b "$BRANCH"
          git add manifests/d/dongdongbh/Mindwtr/"$VERSION"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -m "New version: Mindwtr ${VERSION}"
          git push -u origin "$BRANCH"
          gh pr create \
            --repo microsoft/winget-pkgs \
            --head "dongdongbh:${BRANCH}" \
            --base master \
            --title "New version: Mindwtr ${VERSION}" \
            --body "Automated manifest update for Mindwtr ${VERSION}."

      - name: Commit and push
        run: |
          cd packages-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Casks/mindwtr.rb bucket/mindwtr.json
          if git diff --cached --quiet; then
            echo "No package changes to commit."
            exit 0
          fi
          git commit -m "update: Mindwtr ${{ steps.version.outputs.version }}"
          git push

  update-aur:
    needs: release
    runs-on: ubuntu-latest
    name: Update AUR
    if: startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update PKGBUILD version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating PKGBUILD to version $VERSION"
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" aur/PKGBUILD
        shell: bash

      - name: Update .SRCINFO
        run: |
          docker run --rm \
            -v "$PWD/aur:/aur" \
            -w /aur \
            archlinux:latest \
            bash -lc "pacman -Sy --noconfirm --needed base-devel git && useradd -m builder && chown -R builder:builder /aur && su builder -c 'makepkg --printsrcinfo > .SRCINFO'"
        shell: bash

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v3
        with:
          pkgname: mindwtr-bin
          pkgbuild: ./aur/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update to ${{ github.ref_name }}
          updpkgsums: true
