name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: true
        type: string
      build_ios:
        description: 'Build iOS App (uses EAS cloud minutes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # Build desktop app for all platforms using Tauri
  desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-latest
            target: linux
            deps: sudo apt-get update && sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev
            artifacts: |
              find apps/desktop/src-tauri/target -name "*.AppImage" -exec cp {} release-artifacts/ \;
              find apps/desktop/src-tauri/target -name "*.deb" -exec cp {} release-artifacts/ \;
              find apps/desktop/src-tauri/target -name "*.rpm" -exec cp {} release-artifacts/ \;
          - platform: windows-latest
            target: windows
            deps: echo "No extra deps needed for Windows"
            artifacts: |
              cp apps/desktop/src-tauri/target/release/bundle/msi/*.msi release-artifacts/ 2>/dev/null || true
              cp apps/desktop/src-tauri/target/release/bundle/nsis/*.exe release-artifacts/ 2>/dev/null || true
          - platform: macos-14  # ARM64 runner (Apple Silicon)
            target: macos-arm64
            rust_target: aarch64-apple-darwin
            deps: echo "No extra deps needed for macOS"
            artifacts: |
              cp apps/desktop/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg release-artifacts/ 2>/dev/null || true
              cp apps/desktop/src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz release-artifacts/ 2>/dev/null || true
          - platform: macos-15  # x86_64 runner (Intel)
            target: macos-x64
            rust_target: x86_64-apple-darwin
            deps: echo "No extra deps needed for macOS"
            artifacts: |
              cp apps/desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg release-artifacts/ 2>/dev/null || true
              cp apps/desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz release-artifacts/ 2>/dev/null || true

    runs-on: ${{ matrix.platform }}
    name: Desktop Build (${{ matrix.target }})
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: ${{ matrix.deps }}
        shell: bash

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target || '' }}

      - name: Ensure macOS SetFile is on PATH
        if: runner.os == 'macOS'
        run: |
          if [ -z "$DEVELOPER_DIR" ]; then
            DEVELOPER_DIR="$(xcode-select -p)"
            echo "DEVELOPER_DIR=$DEVELOPER_DIR" >> "$GITHUB_ENV"
          fi
          export DEVELOPER_DIR
          SETFILE_PATH="$(xcrun --find SetFile || true)"
          if [ -n "$SETFILE_PATH" ]; then
            echo "$(dirname "$SETFILE_PATH")" >> "$GITHUB_PATH"
          fi
          which SetFile || true

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build Tauri app (with target)
        if: matrix.rust_target != ''
        run: |
          cd apps/desktop
          cargo tauri build --target ${{ matrix.rust_target }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MACOSX_DEPLOYMENT_TARGET: "10.15"
          CMAKE_OSX_DEPLOYMENT_TARGET: "10.15"
          DEVELOPER_DIR: ${{ env.DEVELOPER_DIR }}

      - name: Build Tauri app (default)
        if: matrix.rust_target == '' || matrix.rust_target == null
        run: |
          cd apps/desktop
          cargo tauri build
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MACOSX_DEPLOYMENT_TARGET: "10.15"
          CMAKE_OSX_DEPLOYMENT_TARGET: "10.15"
          DEVELOPER_DIR: ${{ env.DEVELOPER_DIR }}

      - name: Sign macOS app (ad-hoc)
        if: runner.os == 'macOS'
        run: |
          APP_PATH=$(find apps/desktop/src-tauri/target -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Signing $APP_PATH"
            codesign --force --deep --sign - "$APP_PATH"
          fi
        shell: bash

      - name: Locate and Move artifacts
        run: |
          mkdir -p release-artifacts
          echo "Listing build output for debugging:"
          ls -R apps/desktop/src-tauri/target/release/bundle || echo "Bundle dir not found"
          ${{ matrix.artifacts }}
          ls -la release-artifacts/
        shell: bash
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.target }}
          path: release-artifacts/*
          if-no-files-found: warn


  # Android build (EAS local)
  android:
    runs-on: ubuntu-latest
    name: Android Build (EAS Local)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Build Android APK + AAB (local EAS)
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cd apps/mobile
          MINDWTR_ANDROID_ARCHS=arm64-v8a,armeabi-v7a eas build --platform android --profile production-apk --local --non-interactive --output ./build/mindwtr-${VERSION}.apk
          MINDWTR_ANDROID_ARCHS=arm64-v8a,armeabi-v7a eas build --platform android --profile production --local --non-interactive --output ./build/mindwtr-${VERSION}.aab
          ls -la ./build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: apps/mobile/build/mindwtr-*.apk
          if-no-files-found: error

      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: apps/mobile/build/mindwtr-*.aab
          if-no-files-found: error

  # Optional iOS build (only when manually triggered with build_ios=true)
  ios:
    runs-on: ubuntu-latest
    name: iOS Build (EAS)
    if: ${{ github.event.inputs.build_ios == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Build iOS App
        run: |
          cd apps/mobile
          eas build --platform ios --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download Artifact from EAS
        run: |
          cd apps/mobile
          eas build:list --platform ios --status finished --limit 1 --json > build_ios.json
          BUILD_URL=$(cat build_ios.json | jq -r '.[0].artifacts.buildUrl')
          # Extension depends on build type (tar.gz for simulator, ipa for device)
          curl -L -o ios-app.tar.gz "$BUILD_URL"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: apps/mobile/ios-app.tar.gz
          if-no-files-found: error

  # Create GitHub Release with all artifacts
  release:
    needs: [desktop, android, ios]
    runs-on: ubuntu-latest
    name: Create Release
    if: always() && needs.desktop.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all Desktop artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: desktop-*
          path: ./release-assets
          merge-multiple: true

      - name: Download Android artifact
        if: ${{ needs.android.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./release-assets

      - name: Download iOS artifact
        if: ${{ needs.ios.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: ios-app
          path: ./release-assets

      - name: List release assets
        run: ls -la ./release-assets/ || echo "No assets found"

      - name: Resolve release notes
        id: release_notes
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          NOTES_PATH="docs/release-notes/${CURRENT_TAG}.md"
          ALT_NOTES_PATH="docs/release-notes/${CURRENT_TAG#v}.md"
          if [ -f "$NOTES_PATH" ]; then
            echo "Using release notes at $NOTES_PATH"
            echo "body_path=$NOTES_PATH" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -f "$ALT_NOTES_PATH" ]; then
            echo "Using release notes at $ALT_NOTES_PATH"
            echo "body_path=$ALT_NOTES_PATH" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "No release notes file found; falling back to generated changelog."
          echo "body_path=CHANGELOG.md" >> "$GITHUB_OUTPUT"

      - name: Generate Changelog
        id: changelog
        if: ${{ steps.release_notes.outputs.body_path == 'CHANGELOG.md' }}
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          echo "## What's Changed in $CURRENT_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -n "$PREV_TAG" ]; then
            # Get commit messages between tags
            git log --pretty=format:"- %s" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            # First release - get all commits
            git log --pretty=format:"- %s" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG" >> CHANGELOG.md
          
          cat CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./release-assets/*
          body_path: ${{ steps.release_notes.outputs.body_path }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  aur-release:
    needs: release
    runs-on: ubuntu-latest
    name: AUR Release
    if: always() && needs.release.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update PKGBUILD version
        run: |
          # Strip 'v' prefix from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating PKGBUILD to version $VERSION"
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" aur/PKGBUILD
        shell: bash

      - name: Update .SRCINFO
        run: |
          docker run --rm \
            -v "$PWD/aur:/aur" \
            -w /aur \
            archlinux:latest \
            bash -lc "pacman -Sy --noconfirm --needed base-devel git && useradd -m builder && chown -R builder:builder /aur && su builder -c 'makepkg --printsrcinfo > .SRCINFO'"
        shell: bash

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v3
        with:
          pkgname: mindwtr-bin
          pkgbuild: ./aur/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update to ${{ github.ref_name }}
          updpkgsums: true

  update-packages:
    needs: release
    runs-on: ubuntu-latest
    name: Update Homebrew/Scoop Packages
    if: always() && needs.release.result == 'success'
    steps:
      - name: Checkout packages repo
        uses: actions/checkout@v4
        with:
          repository: dongdongbh/homebrew-mindwtr
          token: ${{ secrets.PACKAGES_REPO_TOKEN }}
          path: packages-repo

      - name: Resolve release version
        id: version
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          TAG="${INPUT_TAG:-${GITHUB_REF#refs/tags/}}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download release assets and compute hashes
        id: hashes
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          URL_DMG_ARM="https://github.com/${{ github.repository }}/releases/download/${TAG}/Mindwtr_${VERSION}_aarch64.dmg"
          URL_DMG_INTEL="https://github.com/${{ github.repository }}/releases/download/${TAG}/Mindwtr_${VERSION}_x64.dmg"
          URL_EXE="https://github.com/${{ github.repository }}/releases/download/${TAG}/Mindwtr_${VERSION}_x64-setup.exe"

          curl -fL -o mindwtr-arm.dmg "$URL_DMG_ARM"
          curl -fL -o mindwtr-intel.dmg "$URL_DMG_INTEL"
          curl -fL -o mindwtr.exe "$URL_EXE"

          SHA_ARM=$(sha256sum mindwtr-arm.dmg | awk '{print $1}')
          SHA_INTEL=$(sha256sum mindwtr-intel.dmg | awk '{print $1}')
          SHA_EXE=$(sha256sum mindwtr.exe | awk '{print $1}')

          echo "sha_arm=$SHA_ARM" >> "$GITHUB_OUTPUT"
          echo "sha_intel=$SHA_INTEL" >> "$GITHUB_OUTPUT"
          echo "sha_exe=$SHA_EXE" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew cask
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA_ARM="${{ steps.hashes.outputs.sha_arm }}"
          SHA_INTEL="${{ steps.hashes.outputs.sha_intel }}"

          FILE="packages-repo/Casks/mindwtr.rb"
          ruby -pi -e "sub(/^  version \".*\"/, \"  version \\\"$VERSION\\\"\")" "$FILE"
          ruby -0777 -pi -e "sub(/sha256 arm:.*?intel: \\\"[^\\\"]+\\\"/m, \"sha256 arm:   \\\"$SHA_ARM\\\",\\n         intel: \\\"$SHA_INTEL\\\"\")" "$FILE"

      - name: Update Scoop manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA_EXE="${{ steps.hashes.outputs.sha_exe }}"
          URL_EXE="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/Mindwtr_${VERSION}_x64-setup.exe#/dl.7z"

          FILE="packages-repo/bucket/mindwtr.json"
          jq --arg v "$VERSION" \
             --arg url "$URL_EXE" \
             --arg hash "$SHA_EXE" \
             '.version = $v
              | .architecture."64bit".url = $url
              | .architecture."64bit".hash = $hash
             | .autoupdate.architecture."64bit".url = "https://github.com/dongdongbh/Mindwtr/releases/download/v\($v)/Mindwtr_\($v)_x64-setup.exe#/dl.7z"' \
             "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"

      - name: Check Winget package exists
        id: winget_check
        run: |
          PKG_ID="dongdongbh.Mindwtr"
          PKG_LOWER="${PKG_ID,,}"
          FIRST="${PKG_LOWER:0:1}"
          URL="https://github.com/microsoft/winget-pkgs/tree/master/manifests/${FIRST}/${PKG_ID//./\/}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
          if [ "$STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Winget package not found yet; skipping submission."
          fi

      - name: Checkout winget-pkgs fork
        if: steps.winget_check.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          repository: dongdongbh/winget-pkgs
          token: ${{ secrets.PACKAGES_REPO_TOKEN }}
          path: winget-pkgs

      - name: Prepare Winget manifests
        if: steps.winget_check.outputs.exists == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          REPO="${{ github.repository }}"
          SHA_EXE="${{ steps.hashes.outputs.sha_exe }}"
          RELEASE_DATE="$(date -u +%Y-%m-%d)"
          INSTALLER_URL="https://github.com/${REPO}/releases/download/${TAG}/Mindwtr_${VERSION}_x64-setup.exe"
          MANIFEST_DIR="winget-pkgs/manifests/d/dongdongbh/Mindwtr/${VERSION}"

          mkdir -p "$MANIFEST_DIR"

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.installer.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.installer.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          InstallerLocale: en-US
          InstallerType: nullsoft
          InstallModes:
            - interactive
            - silent
          UpgradeBehavior: install
          Commands:
            - mindwtr
          Dependencies:
            PackageDependencies:
              - PackageIdentifier: Microsoft.VCRedist.2015+.x64
          ProductCode: Mindwtr
          ReleaseDate: ${RELEASE_DATE}
          AppsAndFeaturesEntries:
            - ProductCode: Mindwtr
          InstallationMetadata:
            DefaultInstallLocation: '%LOCALAPPDATA%\\Programs\\Mindwtr'
          Installers:
            - Architecture: x64
              InstallerUrl: ${INSTALLER_URL}
              InstallerSha256: ${SHA_EXE}
          ManifestType: installer
          ManifestVersion: 1.10.0
          EOF

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.locale.en-US.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.defaultLocale.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          PackageLocale: en-US
          Publisher: dongdongbh
          PublisherUrl: https://github.com/dongdongbh
          PublisherSupportUrl: https://github.com/dongdongbh/Mindwtr/issues
          Author: dongdongbh
          PackageName: Mindwtr
          PackageUrl: https://github.com/dongdongbh/Mindwtr
          License: MIT
          LicenseUrl: https://github.com/dongdongbh/Mindwtr/blob/HEAD/LICENSE
          ShortDescription: A complete Getting Things Done (GTD) productivity system.
          Description: A complete Getting Things Done (GTD) productivity system.
          ReleaseNotes: See the release notes at ${TAG}.
          Moniker: mindwtr
          Tags:
            - cross-platform
            - getting-things-done
            - gtd
            - gtd-applications
            - gtd-workflow
            - personal-management
            - productivity
            - second-brain
            - task-management
            - todo-app
          ReleaseNotesUrl: https://github.com/${REPO}/releases/tag/${TAG}
          ManifestType: defaultLocale
          ManifestVersion: 1.10.0
          EOF

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.version.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.10.0
          EOF

      - name: Submit Winget PR
        if: steps.winget_check.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.PACKAGES_REPO_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="mindwtr-${VERSION}"
          cd winget-pkgs
          git checkout -b "$BRANCH"
          git add manifests/d/dongdongbh/Mindwtr/"$VERSION"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -m "New version: Mindwtr ${VERSION}"
          git push -u origin "$BRANCH"
          gh pr create \
            --repo microsoft/winget-pkgs \
            --head "dongdongbh:${BRANCH}" \
            --base master \
            --title "New version: Mindwtr ${VERSION}" \
            --body "Automated manifest update for Mindwtr ${VERSION}."

      - name: Commit and push
        run: |
          cd packages-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Casks/mindwtr.rb bucket/mindwtr.json
          if git diff --cached --quiet; then
            echo "No package changes to commit."
            exit 0
          fi
          git commit -m "update: Mindwtr ${{ steps.version.outputs.version }}"
          git push
