name: Build Windows MSIX

on:
  workflow_dispatch:

env:
  MS_IDENTITY_NAME: "DongdaLi.Mindwtr"
  MS_PUBLISHER_ID: "CN=76AC9B15-7A1B-49FF-9342-2BE80735A1E6"
  MS_PUBLISHER_DISPLAY_NAME: "Dongda Li"
  MSIX_VERSION: "0.6.2.0"

jobs:
  build-msix:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0"

      - name: Install dependencies
        run: bun install

      - name: Build Tauri App
        run: |
          cd apps/desktop
          cargo tauri build --target x86_64-pc-windows-msvc

      - name: Create MSIX Layout
        shell: pwsh
        run: |
          $buildDir = "apps/desktop/src-tauri/target/x86_64-pc-windows-msvc/release"
          $outDir = "msix-staging"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          New-Item -ItemType Directory -Force -Path "$outDir\Assets" | Out-Null

          $exe = Get-ChildItem -Path $buildDir -Filter "*.exe" | Select-Object -First 1
          if (-not $exe) { throw "No exe found in $buildDir" }
          Copy-Item $exe.FullName -Destination "$outDir\mindwtr.exe"

          Copy-Item "apps/desktop/src-tauri/icons/StoreLogo.png" "$outDir\Assets\StoreLogo.png"
          Copy-Item "apps/desktop/src-tauri/icons/Square150x150Logo.png" "$outDir\Assets\Square150x150Logo.png"
          Copy-Item "apps/desktop/src-tauri/icons/Square44x44Logo.png" "$outDir\Assets\Square44x44Logo.png"

      - name: Generate AppxManifest.xml
        shell: pwsh
        run: |
          $manifest = @"
          <?xml version="1.0" encoding="utf-8"?>
          <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                   xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                   xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
            <Identity Name="$env:MS_IDENTITY_NAME"
                      Publisher="$env:MS_PUBLISHER_ID"
                      Version="$env:MSIX_VERSION" />
            <Properties>
              <DisplayName>Mindwtr</DisplayName>
              <PublisherDisplayName>$env:MS_PUBLISHER_DISPLAY_NAME</PublisherDisplayName>
              <Logo>Assets\StoreLogo.png</Logo>
            </Properties>
            <Dependencies>
              <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxVersionTested="10.0.19041.0" />
            </Dependencies>
            <Resources>
              <Resource Language="en-us" />
            </Resources>
            <Applications>
              <Application Id="App" Executable="mindwtr.exe" EntryPoint="Windows.FullTrustApplication">
                <uap:VisualElements DisplayName="Mindwtr"
                                    Description="Local-first GTD application"
                                    BackgroundColor="transparent"
                                    Square150x150Logo="Assets\Square150x150Logo.png"
                                    Square44x44Logo="Assets\Square44x44Logo.png">
                </uap:VisualElements>
              </Application>
            </Applications>
            <Capabilities>
              <rescap:Capability Name="runFullTrust" />
            </Capabilities>
          </Package>
          "@
          $manifest | Out-File -FilePath "msix-staging\AppxManifest.xml" -Encoding UTF8

      - name: Build MSIX Package
        shell: pwsh
        run: |
          $msixPath = "mindwtr.msix"
          $kitsRoot = "C:\Program Files (x86)\Windows Kits"
          Write-Host "Searching for x64 makeappx.exe in $kitsRoot..."
          $makeappx = Get-ChildItem -Path $kitsRoot -Recurse -Filter "makeappx.exe" -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -match "\\\\x64\\\\" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName

          if (-not $makeappx) {
            Write-Error "Could not find x64 makeappx.exe. Listing all candidates:"
            Get-ChildItem -Path $kitsRoot -Recurse -Filter "makeappx.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          Write-Host "Using MakeAppx at: $makeappx"
          & $makeappx pack /d msix-staging /p $msixPath /o

      - name: Upload MSIX
        uses: actions/upload-artifact@v4
        with:
          name: mindwtr-msix
          path: mindwtr.msix
