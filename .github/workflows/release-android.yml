name: Release Android

on:
  workflow_call:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  android:
    runs-on: ubuntu-latest
    name: Android Build + Publish
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.x"

      - name: Install dependencies
        run: bun install

      - name: Authenticate Google Play API
        id: play_auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}
          token_format: access_token
          access_token_scopes: https://www.googleapis.com/auth/androidpublisher

      - name: Ensure Android versionCode is unique
        env:
          ACCESS_TOKEN: ${{ steps.play_auth.outputs.access_token }}
        run: |
          PACKAGE="tech.dongdongbh.mindwtr"
          EDIT_ID=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE/edits" \
            -d '{}' | jq -r '.id')
          if [ -z "$EDIT_ID" ] || [ "$EDIT_ID" = "null" ]; then
            echo "Failed to create Google Play edit" >&2
            exit 1
          fi
          TRACKS_FILE=$(mktemp)
          TRACKS_CODE=$(curl -sS -o "$TRACKS_FILE" -w "%{http_code}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE/edits/$EDIT_ID/tracks")
          TRACKS_JSON=$(cat "$TRACKS_FILE")
          if [ "$TRACKS_CODE" != "200" ]; then
            echo "Failed to fetch Google Play tracks (HTTP $TRACKS_CODE): $TRACKS_JSON" >&2
            exit 1
          fi
          if echo "$TRACKS_JSON" | jq -e '.error' >/dev/null; then
            echo "Failed to fetch Google Play tracks: $TRACKS_JSON" >&2
            exit 1
          fi
          MAX_CODE=$(echo "$TRACKS_JSON" | jq -r '[(.tracks // [])[]? | (.releases // [])[]? | (.versionCodes // [])[]? | tonumber] | max // 0')
          if [ -z "$MAX_CODE" ] || [ "$MAX_CODE" = "null" ]; then
            MAX_CODE=0
          fi
          curl -s -X DELETE \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE/edits/$EDIT_ID" >/dev/null
          LOCAL_CODE=$(jq -r '.expo.android.versionCode' apps/mobile/app.json)
          if [ -z "$LOCAL_CODE" ] || [ "$LOCAL_CODE" = "null" ]; then
            echo "Missing expo.android.versionCode in apps/mobile/app.json" >&2
            exit 1
          fi
          if [ "$MAX_CODE" -ge "$LOCAL_CODE" ]; then
            NEW_CODE=$((MAX_CODE + 1))
            jq ".expo.android.versionCode = $NEW_CODE" apps/mobile/app.json > apps/mobile/app.json.tmp
            mv apps/mobile/app.json.tmp apps/mobile/app.json
            echo "Bumped versionCode to $NEW_CODE (store max was $MAX_CODE)"
          else
            echo "versionCode ok: local $LOCAL_CODE > store $MAX_CODE"
          fi

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Resolve version
        id: version
        run: |
          TAG_INPUT="${{ inputs.tag }}"
          if [ -z "$TAG_INPUT" ]; then
            TAG_INPUT="${{ github.event.inputs.tag }}"
          fi
          if [ -n "$TAG_INPUT" ]; then
            TAG="$TAG_INPUT"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Build Android APK + AAB (local EAS)
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cd apps/mobile
          MINDWTR_ANDROID_ARCHS=arm64-v8a,armeabi-v7a eas build --platform android --profile production-apk --local --non-interactive --output ./build/mindwtr-${VERSION}.apk
          MINDWTR_ANDROID_ARCHS=arm64-v8a,armeabi-v7a eas build --platform android --profile production --local --non-interactive --output ./build/mindwtr-${VERSION}.aab
          ls -la ./build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Verify Android APK permissions
        run: |
          APK_PATH="$(ls apps/mobile/build/mindwtr-*.apk | head -1)"
          if [[ -z "${APK_PATH}" ]]; then
            echo "No APK produced for permission verification" >&2
            exit 1
          fi
          AAPT_BIN="$(command -v aapt || true)"
          if [[ -z "${AAPT_BIN}" ]]; then
            AAPT_BIN="$(ls "${ANDROID_HOME}"/build-tools/*/aapt 2>/dev/null | sort -V | tail -1)"
          fi
          if [[ -z "${AAPT_BIN}" ]]; then
            echo "aapt not found; cannot verify APK permissions" >&2
            exit 1
          fi
          PERMS_DUMP="$(mktemp)"
          "${AAPT_BIN}" dump permissions "${APK_PATH}" | tee "${PERMS_DUMP}"
          for perm in \
            android.permission.CAMERA \
            android.permission.SYSTEM_ALERT_WINDOW \
            android.permission.READ_EXTERNAL_STORAGE \
            android.permission.WRITE_EXTERNAL_STORAGE; do
            if grep -q "name='${perm}'" "${PERMS_DUMP}"; then
              echo "${perm} still present in APK manifest" >&2
              exit 1
            fi
          done
          if ! grep -q "name='android.permission.RECORD_AUDIO'" "${PERMS_DUMP}"; then
            echo "android.permission.RECORD_AUDIO missing in APK manifest" >&2
            exit 1
          fi
          echo "Verified APK permissions: CAMERA/storage/alert removed; RECORD_AUDIO present."

      - name: Prepare Google Play release notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          NOTES_FILE="docs/release-notes/google-play/${VERSION}.txt"
          if [ ! -f "$NOTES_FILE" ]; then
            echo "Missing release notes file: $NOTES_FILE" >&2
            exit 1
          fi
          OUT_DIR="apps/mobile/build/play-release-notes"
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"
          awk -v out="$OUT_DIR" '
            /^<[^>]+>$/ {
              tag=$0
              gsub(/[<>]/, "", tag)
              file=out "/whatsnew-" tag
              next
            }
            /^<\/[^>]+>$/ {
              tag=""
              next
            }
            tag != "" { print >> file }
          ' "$NOTES_FILE"
          ls -la "$OUT_DIR"

      - name: Publish to Google Play Store
        if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'workflow_dispatch'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}
          packageName: tech.dongdongbh.mindwtr
          releaseFiles: apps/mobile/build/mindwtr-*.aab
          track: production
          status: completed
          releaseName: ${{ steps.version.outputs.version }}
          whatsNewDirectory: apps/mobile/build/play-release-notes

      - name: Collect Android artifacts
        run: |
          mkdir -p release-artifacts
          cp apps/mobile/build/mindwtr-*.apk release-artifacts/
          cp apps/mobile/build/mindwtr-*.aab release-artifacts/
          ls -la release-artifacts

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-android
          path: release-artifacts/*
          if-no-files-found: error
