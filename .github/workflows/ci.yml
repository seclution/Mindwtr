name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Core package tests
  core:
    runs-on: ubuntu-latest
    name: Core Package
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.x"

      - name: Install dependencies
        run: |
          set -e
          bun install || (echo "bun install failed, clearing cache and retrying..." && (bun pm cache rm || bun pm cache clean || true) && bun install)

      - name: TypeScript check
        run: cd packages/core && bun run tsc --noEmit

      - name: Run unit tests
        run: cd packages/core && bun test

  # Desktop app build and tests (Tauri)
  desktop:
    runs-on: ubuntu-latest
    name: Desktop App (Tauri)
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies (Tauri)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Ensure Rust toolchain (retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            rustup toolchain install stable --profile minimal --no-self-update
            rustup default stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.x"

      - name: Install dependencies
        run: bun install

      - name: TypeScript check
        run: cd apps/desktop && bun run tsc --noEmit

      - name: Run tests
        run: cd apps/desktop && bun test

      - name: Build Vite frontend
        run: cd apps/desktop && bun run build:vite

      - name: Build Tauri app (debug, no bundle)
        run: cd apps/desktop && cargo tauri build --debug --no-bundle

  # Mobile app validation
  mobile:
    runs-on: ubuntu-latest
    name: Mobile App
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.x"

      - name: Install dependencies
        run: bun install

      - name: TypeScript check
        run: cd apps/mobile && bunx tsc --noEmit

      - name: Expo Doctor check
        run: cd apps/mobile && bunx expo-doctor
        continue-on-error: true

      - name: Mobile tests
        run: bun run --filter mobile test

  # Lint check
  lint:
    runs-on: ubuntu-latest
    name: Code Quality
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.x"

      - name: Install dependencies
        run: bun install

      - name: Performance audit
        run: bun run scripts/audit-performance.ts --fail-under 60

      - name: Check for lint errors (mobile)
        run: cd apps/mobile && bun run lint
