name: Update Linux Repos
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v0.6.3)"
        required: true
        type: string
  workflow_call:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v0.6.3)"
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-repo:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Import GPG Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Set release tag (release event)
        if: github.event_name == 'release'
        run: echo "RELEASE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

      - name: Set release tag (manual)
        if: github.event_name == 'workflow_dispatch'
        run: echo "RELEASE_TAG=${{ inputs.tag }}" >> $GITHUB_ENV
      
      - name: Set release tag (workflow call)
        if: github.event_name == 'workflow_call'
        run: |
          TAG="${{ inputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"

      - name: Set release tag (push)
        if: github.event_name == 'push'
        run: |
          TAG="${{ inputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"

      - name: Download Release Assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${RELEASE_TAG:-${GITHUB_REF_NAME}}"
          MAX_RETRIES=5
          for attempt in $(seq 1 "${MAX_RETRIES}"); do
            echo "Downloading release assets for ${TAG} (attempt ${attempt}/${MAX_RETRIES})"
            if gh release download "${TAG}" \
              --repo "${GITHUB_REPOSITORY}" \
              --pattern "*" \
              --clobber; then
              echo "Release assets downloaded successfully."
              break
            fi
            if [ "${attempt}" -eq "${MAX_RETRIES}" ]; then
              echo "Failed to download release assets after ${MAX_RETRIES} attempts." >&2
              exit 1
            fi
            sleep $((attempt * 10))
          done

      - name: Prepare Repo Directories
        run: |
          set -euo pipefail
          mkdir -p build_repo/deb build_repo/rpm
          shopt -s nullglob
          debs=( *.deb )
          rpms=( *.rpm )
          if [ ${#debs[@]} -gt 0 ]; then mv "${debs[@]}" build_repo/deb/; fi
          if [ ${#rpms[@]} -gt 0 ]; then mv "${rpms[@]}" build_repo/rpm/; fi
          gpg --armor --export > build_repo/mindwtr.gpg.key

      - name: Build DEB Repo
        working-directory: build_repo/deb
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-utils
          apt-ftparchive packages . > Packages
          apt-ftparchive release . > Release
          gpg --batch --yes --clearsign -o InRelease Release
          gpg --batch --yes -abs -o Release.gpg Release

      - name: Build RPM Repo
        working-directory: build_repo/rpm
        run: |
          sudo apt-get update
          sudo apt-get install -y createrepo-c
          createrepo_c .
          if [ -f repodata/repomd.xml ]; then
            gpg --batch --yes --armor --detach-sign -o repodata/repomd.xml.asc repodata/repomd.xml
          else
            echo "repodata/repomd.xml not found after createrepo_c" >&2
            exit 1
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build_repo
          publish_branch: gh-pages
          keep_files: true
